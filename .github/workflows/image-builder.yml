name: ImageBuilder
# Run this workflow every time a new commit pushed to your repository
on: push

permissions:
  id-token: write
  contents: read

jobs:
  build:
    name: Retrieve Secrets from Vault
    runs-on: self-hosted
    steps:
        - name: Checkout repository
          uses: actions/checkout@v3 

        - name: Import Secrets
          id: vault
          uses: hashicorp/vault-action@v2
          with:
            url: http://127.0.0.1:8200
            method: jwt
            jwtGithubAudience: https://github.com
            role: gh-actions
            tlsSkipVerify: true
            # Removed preceding backslash so GitHub evaluates the expression and passes the real token
            #token: ${{ secrets.VAULT_TOKEN }}
            secrets: |
              secret/data/ci app_secret

        - name: Verify Vault secrets loaded
          run: |
              set -euo pipefail
              for v in APP_SECRET; do
                val="${!v:-}"
                if [ -n "$val" ]; then
                  echo "$v: present (length=${#val})"
                else
                  echo "$v: NOT SET"
                fi
              done

        - name: Show GitHub OIDC token claims
          run: |
            ID_TOKEN=$(curl -sLS "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=https://github.com" -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN")
            echo "$ID_TOKEN" | cut -d. -f2 | base64 -d | jq .
          env:
            ACTIONS_ID_TOKEN_REQUEST_URL: ${{ env.ACTIONS_ID_TOKEN_REQUEST_URL }}
            ACTIONS_ID_TOKEN_REQUEST_TOKEN: ${{ env.ACTIONS_ID_TOKEN_REQUEST_TOKEN }}
